import React, { useState, useEffect } from 'react';
import { Sparkles, Gift, X, Star, Snowflake, Heart, RefreshCw } from 'lucide-react';

const ChristmasGiftV12 = () => {
  const [gameState, setGameState] = useState('idle'); // idle, shaking, opening, result
  const [result, setResult] = useState(null);
  const [activeId, setActiveId] = useState(null);
  const [snowflakes, setSnowflakes] = useState([]);

  // â˜… çé …è¨­å®š â˜…
  const prizes = [
    { id: 1, name: "é ­çï¼šå¥èƒ¸æ¿€å¯¦éœœ (ä¹™ç½)", desc: "é ‚ç´šè³¦æ´»ï¼Œæ¥µè‡´ç·Šå¯¦", type: "grand", color: "text-rose-700", bg: "bg-rose-50", weight: 1 },
    { id: 2, name: "äºŒçï¼šç¾èƒ¸è³¦æ´»ä¹³éœœ (ä¹™æ¢)", desc: "å½ˆæ½¤æ»‹é¤Šï¼ŒæŸ”å«©å‘µè­·", type: "grand", color: "text-pink-700", bg: "bg-pink-50", weight: 2 },
    { id: 3, name: "ä¸‰çï¼šæŒ‰æ‘©ç²¾æ²¹ (ä¹™ç½)", desc: "èŠ³ç™‚èˆ’å£“ï¼Œèº«å¿ƒå¹³è¡¡", type: "grand", color: "text-amber-700", bg: "bg-amber-50", weight: 3 },
    { id: 4, name: "5æŠ˜ é©šå–œå„ªæƒ ", desc: "è–èª•å¥‡è¹Ÿï¼ŒåŠåƒ¹å¯µæ„›", type: "discount", color: "text-purple-700", bg: "bg-purple-50", weight: 1 },
    { id: 9, name: "9æŠ˜ å„ªæƒ åˆ¸", desc: "å°ç¢ºå¹¸æŠ˜æ‰£ï¼Œç«‹å³ä½¿ç”¨", type: "discount", color: "text-teal-700", bg: "bg-teal-50", weight: 25 },
    { id: 10, name: "95æŠ˜ å„ªæƒ åˆ¸", desc: "é«”é©—æŠ˜æ‰£ï¼Œè¼•é¬†å…¥æ‰‹", type: "discount", color: "text-teal-700", bg: "bg-teal-50", weight: 30 },
    { id: 11, name: "å°ç¦®ï¼šç†±æ•·çœ¼ç½© (ä¹™ç‰‡)", desc: "èˆ’ç·©çœ¼å£“ï¼Œæš–æš–å…¥ç¡", type: "gift", color: "text-orange-700", bg: "bg-orange-50", weight: 35 },
    { id: 12, name: "å°ç¦®ï¼šç†±æ•·è²¼ (ä¹™ç‰‡)", desc: "æš–å®®æš–èº«ï¼Œéš¨èº«å‘µè­·", type: "gift", color: "text-orange-700", bg: "bg-orange-50", weight: 35 },
    { id: 13, name: "å°ç¦®ï¼šç”œèœœç³–æœç½", desc: "é‡‘æ²™/ç³–æœï¼Œç”œåœ¨å¿ƒé ­", type: "gift", color: "text-orange-700", bg: "bg-orange-50", weight: 35 },
  ];

  useEffect(() => {
    const flakes = Array.from({ length: 25 }).map((_, i) => ({
      id: i,
      left: Math.random() * 100,
      animDuration: 8 + Math.random() * 5 + 's',
      delay: Math.random() * 5 + 's',
      opacity: 0.3 + Math.random() * 0.5,
      size: 8 + Math.random() * 8
    }));
    setSnowflakes(flakes);
  }, []);

  // â˜… V12 ä¿®æ­£ç‰ˆè–èª•æ¨¹ï¼šæ˜Ÿæ˜Ÿå›æ­¸ â˜…
  const KawaiiTree = () => (
    <svg viewBox="0 0 200 260" className="w-full h-full drop-shadow-xl animate-float-slow">
        {/* æ¨¹å¹¹ */}
        <path d="M85 250 L85 180 L115 180 L115 250 Z" fill="#b45309" stroke="#92400e" strokeWidth="2" strokeLinejoin="round" />
        
        {/* æ¨¹é«” */}
        <path d="M20 190 C20 190, 50 160, 100 160 C150 160, 180 190, 180 190 C180 190, 150 220, 100 220 C50 220, 20 190, 20 190 Z" fill="#6ee7b7" stroke="#059669" strokeWidth="2" strokeLinejoin="round" />
        <path d="M40 140 C40 140, 60 110, 100 110 C140 110, 160 140, 160 140 C160 140, 130 170, 100 170 C70 170, 40 140, 40 140 Z" fill="#34d399" stroke="#059669" strokeWidth="2" strokeLinejoin="round" />
        <path d="M60 90 C60 90, 70 50, 100 50 C130 50, 140 90, 140 90 C140 90, 120 120, 100 120 C80 120, 60 90, 60 90 Z" fill="#10b981" stroke="#059669" strokeWidth="2" strokeLinejoin="round" />
        
        {/* é«˜å…‰ */}
        <path d="M40 190 Q50 180 60 190" fill="none" stroke="white" strokeWidth="3" strokeLinecap="round" opacity="0.3" />
        <path d="M60 140 Q70 130 80 140" fill="none" stroke="white" strokeWidth="3" strokeLinecap="round" opacity="0.3" />
        <path d="M80 90 Q90 80 100 90" fill="none" stroke="white" strokeWidth="3" strokeLinecap="round" opacity="0.3" />

        {/* é ‚éƒ¨æ˜Ÿæ˜Ÿ (Star Shape) */}
        <path d="M100 25 L106 40 L122 40 L110 50 L114 65 L100 55 L86 65 L90 50 L78 40 L94 40 Z" fill="#fbbf24" stroke="#f59e0b" strokeWidth="1.5" className="animate-pulse" />
        
        {/* è£é£¾å½©å¸¶ */}
        <path d="M50 170 Q100 190 150 170" fill="none" stroke="#fcd34d" strokeWidth="3" strokeLinecap="round" opacity="0.6" />
        <path d="M70 120 Q100 140 130 120" fill="none" stroke="#fcd34d" strokeWidth="3" strokeLinecap="round" opacity="0.6" />
    </svg>
  );

  // â˜… è£é£¾çƒ (Burst Effect) â˜…
  const BurstOrnament = ({ id, color, x, y, onClick, state }) => {
    const isTarget = state.activeId === id;
    const isPopping = state.gameState !== 'idle' && isTarget;

    if (isPopping) {
        return (
            <div className="absolute w-12 h-12 z-30 pointer-events-none" style={{ left: `${x}%`, top: ${y}% }}>
                <div className="absolute inset-0 flex items-center justify-center animate-pop-vanish">
                    <Sparkles className="text-white w-full h-full fill-white" />
                </div>
            </div>
        );
    }

    return (
        <div 
            onClick={() => onClick(id)}
            className="absolute w-10 h-10 cursor-pointer transform transition-transform hover:scale-125 hover:brightness-110 z-20"
            style={{ left: `${x}%`, top: ${y}% }}
        >
            <svg viewBox="0 0 100 100" className="w-full h-full drop-shadow-md">
                <line x1="50" y1="0" x2="50" y2="10" stroke="white" strokeWidth="2" />
                <circle cx="50" cy="55" r="40" fill={color} stroke="white" strokeWidth="2" />
                <circle cx="35" cy="40" r="10" fill="white" opacity="0.5" />
            </svg>
        </div>
    );
  };

  // â˜… ç¦®ç‰©ç›’ (Jump & Explode) â˜…
  const JumpGiftBox = ({ id, color, ribbon, onClick, state }) => {
    const isTarget = state.activeId === id;
    const isOpening = state.gameState === 'opening' && isTarget;
    const isShaking = state.gameState === 'shaking' && isTarget;

    const colors = {
      rose: { box: "#fbcfe8", ribbon: "#db2777" },
      gold: { box: "#fef3c7", ribbon: "#d97706" },
      blue: { box: "#bae6fd", ribbon: "#2563eb" }
    };
    const c = colors[color];

    return (
      <div 
        onClick={() => onClick(id)}
        className={`relative w-24 h-24 cursor-pointer z-20 transition-transform ${!isOpening && !isShaking ? 'hover:scale-110' : ''}`}
        style={{
             animation: isShaking ? 'jump-ready 0.6s ease-in-out' : undefined
        }}
      >
        <svg viewBox="0 0 100 100" className="w-full h-full drop-shadow-md">
           <rect x="15" y="40" width="70" height="50" rx="6" fill={c.box} stroke="white" strokeWidth="2" />
           <rect x="45" y="40" width="10" height="50" fill={c.ribbon} opacity="0.8" />
           
           <g className={isOpening ? 'animate-lid-fly-off' : ''} style={{transformOrigin: '50% 40%'}}>
              <rect x="10" y="30" width="80" height="15" rx="4" fill={c.box} stroke="white" strokeWidth="2" />
              <rect x="45" y="30" width="10" height="15" fill={c.ribbon} />
              <circle cx="50" cy="30" r="6" fill={c.ribbon} />
              <path d="M50 30 Q30 10 10 30 Q30 45 50 35" fill={c.ribbon} />
              <path d="M50 30 Q70 10 90 30 Q70 45 50 35" fill={c.ribbon} />
           </g>

           {isOpening && (
               <g className="animate-confetti">
                   <circle cx="20" cy="40" r="3" fill="#fcd34d" />
                   <circle cx="80" cy="40" r="3" fill="#f472b6" />
                   <rect x="40" y="30" width="4" height="4" fill="#60a5fa" transform="rotate(45)" />
                   <rect x="60" y="25" width="4" height="4" fill="#34d399" transform="rotate(20)" />
               </g>
           )}
        </svg>
      </div>
    );
  };

  const handleInteraction = (id) => {
    if (gameState !== 'idle') return;
    setActiveId(id);

    const isBall = id.includes('ball');
    const totalWeight = prizes.reduce((sum, item) => sum + item.weight, 0);
    let randomNum = Math.random() * totalWeight;
    let selected = prizes[0];
    for (let p of prizes) {
        if (randomNum < p.weight) {
            selected = p;
            break;
        }
        randomNum -= p.weight;
    }
    setResult(selected);

    if (isBall) {
        setGameState('opening'); 
        setTimeout(() => setGameState('result'), 600);
    } else {
        setGameState('shaking'); 
        setTimeout(() => {
            setGameState('opening'); 
            setTimeout(() => setGameState('result'), 1000);
        }, 600);
    }
  };

  const resetGame = () => {
    setGameState('idle');
    setResult(null);
    setActiveId(null);
  };

  const getLineUrl = () => {
    if (!result) return "#";
    const message = `æˆ‘åœ¨å¯å”¯ç¾å­¸è–èª•é©šå–œæŠ½åˆ°äº†ã€${result.name}ã€‘ğŸ\næƒ³è¦ç¾å ´å…Œæ›ï¼`;
    return `https://line.me/R/oaMessage/@kewibeauty/?${encodeURIComponent(message)}`;
  };

  return (
    <div className="h-screen w-full flex flex-col items-center justify-center p-4 relative overflow-hidden font-serif select-none bg-[#fdfcf8]">
        
        {/* èƒŒæ™¯ */}
        <div className="absolute inset-0 bg-gradient-to-b from-[#fdfcf8] to-[#fff1f2]"></div>
        <div className="absolute inset-0 pointer-events-none opacity-30" style={{backgroundImage: 'radial-gradient(#fecdd3 1px, transparent 1px)', backgroundSize: '16px 16px'}}></div>
        
        {/* é£„é›ª */}
        <div className="absolute inset-0 pointer-events-none">
            {snowflakes.map(flake => (
                <div 
                    key={flake.id}
                    className="absolute text-rose-200"
                    style={{
                        left: `${flake.left}%`,
                        animation: `snow ${flake.animDuration} linear infinite`,
                        animationDelay: flake.delay,
                        opacity: flake.opacity,
                        fontSize: `${flake.size}px`,
                        top: '-20px'
                    }}
                >
                    â„
                </div>
            ))}
        </div>

        {/* Header (æ·¡å‡º) */}
        <div className={`z-10 text-center mb-2 relative transition-all duration-500 ${gameState === 'result' ? 'opacity-0 translate-y-[-20px]' : 'opacity-100'}`}>
            <div className="inline-flex items-center gap-2 px-5 py-1.5 bg-white/70 backdrop-blur-md rounded-full mb-3 border border-rose-200 shadow-sm">
               <Gift size={12} className="text-rose-500"/>
               <span className="text-rose-900 text-[10px] tracking-[0.2em] font-medium">MERRY CHRISTMAS</span>
            </div>
            <h1 className="text-3xl text-gray-800 tracking-[0.1em] mb-2 font-bold drop-shadow-sm text-rose-950">è–èª•é©šå–œ
